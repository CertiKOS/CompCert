
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Conventions</title>
<meta name="description" content="Documentation of Coq module Conventions" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Conventions</h1>
<div class="coq">
<br/>
<div class="doc">Function calling conventions and other conventions regarding the use of
    machine registers and stack slots. </div>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compcert.lib.Coqlib.html">Coqlib</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compcert.common.AST.html">AST</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compcert.common.Values.html">Values</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compcert.common.Memory.html">Memory</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compcert.common.LanguageInterface.html">LanguageInterface</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="compcert.backend.Locations.html">Locations</a></span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id"><a href="compcert.x86.Conventions1.html">Conventions1</a></span>.<br/>
<br/>
<div class="doc">The processor-dependent and EABI-dependent definitions are in
    <span class="bracket"><span class="id">arch</span>/<span class="id">abi</span>/<span class="id">Conventions1.v</span></span>.  This file adds various processor-independent
    definitions and lemmas. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="loc_arguments_acceptable_2">loc_arguments_acceptable_2</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#In">In</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> (<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#s">s</a></span>)) -&gt; <span class="id"><a href="compcert.x86.Conventions1.html#loc_argument_acceptable">loc_argument_acceptable</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4009')">Proof.</div>
<div class="proofscript" id="proof4009">
&nbsp;&nbsp;<span class="tactic">intros</span> <span class="id">until</span> <span class="id">l</span>. <span class="tactic">generalize</span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments_acceptable">loc_arguments_acceptable</a></span> <span class="id">s</span>). <span class="tactic">generalize</span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id">s</span>).<br/>
&nbsp;&nbsp;<span class="tactic">induction</span> <span class="id">l0</span> <span class="kwd">as</span> [ | <span class="id">p</span> <span class="id">pl</span>]; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
- <span class="id">contradiction</span>.<br/>
- <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#in_app_iff">in_app_iff</a></span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">destruct</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id">H</span>; <span class="tactic">eauto</span>. <span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> *; <span class="tactic">intuition</span> <span class="tactic">congruence</span>.<br/>
&nbsp;&nbsp;<span class="tactic">apply</span> <span class="id">IHpl</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h2> Location of function parameters </h2>
<br/>
<div class="doc">A function finds the values of its parameter in the same locations
  where its caller stored them, except that the stack-allocated arguments,
  viewed as <span class="bracket"><span class="id">Outgoing</span></span> slots by the caller, are accessed via <span class="bracket"><span class="id">Incoming</span></span>
  slots (at the same offsets and types) in the callee. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="parameter_of_argument">parameter_of_argument</a></span> (<span class="id">l</span>: <span class="id"><a href="compcert.backend.Locations.html#loc">loc</a></span>) : <span class="id"><a href="compcert.backend.Locations.html#loc">loc</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id"><a href="compcert.backend.Locations.html#Outgoing">Outgoing</a></span> <span class="id">n</span> <span class="id">ty</span> =&gt; <span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id"><a href="compcert.backend.Locations.html#Incoming">Incoming</a></span> <span class="id">n</span> <span class="id">ty</span><br/>
&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="loc_parameters">loc_parameters</a></span> (<span class="id">s</span>: <span class="id"><a href="compcert.common.AST.html#signature">signature</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#list">list</a></span> (<span class="id"><a href="compcert.common.AST.html#rpair">rpair</a></span> <span class="id"><a href="compcert.backend.Locations.html#loc">loc</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#map">List.map</a></span> (<span class="id"><a href="compcert.common.AST.html#map_rpair">map_rpair</a></span> <span class="id"><a href="compcert.backend.Conventions.html#parameter_of_argument">parameter_of_argument</a></span>) (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#s">s</a></span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="incoming_slot_in_parameters">incoming_slot_in_parameters</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ofs</span> <span class="id">ty</span> <span class="id">sg</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#In">In</a></span> (<span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id"><a href="compcert.backend.Locations.html#Incoming">Incoming</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ofs">ofs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ty">ty</a></span>) (<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#loc_parameters">loc_parameters</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#In">In</a></span> (<span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id"><a href="compcert.backend.Locations.html#Outgoing">Outgoing</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ofs">ofs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ty">ty</a></span>) (<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>)).<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4010')">Proof.</div>
<div class="proofscript" id="proof4010">
&nbsp;&nbsp;<span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">replace</span> (<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#loc_parameters">loc_parameters</a></span> <span class="id">sg</span>)) <span class="kwd">with</span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#map">List.map</a></span> <span class="id"><a href="compcert.backend.Conventions.html#parameter_of_argument">parameter_of_argument</a></span> (<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id">sg</span>))) <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id"><a href="compcert.backend.Locations.html#Incoming">Incoming</a></span> <span class="id">ofs</span> <span class="id">ty</span>) <span class="kwd">with</span> (<span class="id"><a href="compcert.backend.Conventions.html#parameter_of_argument">parameter_of_argument</a></span> (<span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id"><a href="compcert.backend.Locations.html#Outgoing">Outgoing</a></span> <span class="id">ofs</span> <span class="id">ty</span>)) <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id"><a href="compcert.lib.Coqlib.html#list_in_map_inv">list_in_map_inv</a></span>. <span class="id">eexact</span> <span class="id">H</span>. <span class="tactic">intros</span> [<span class="id">x</span> [<span class="id">A</span> <span class="id">B</span>]]. <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">A</span>.<br/>
&nbsp;&nbsp;<span class="id">exploit</span> <span class="id"><a href="compcert.backend.Conventions.html#loc_arguments_acceptable_2">loc_arguments_acceptable_2</a></span>; <span class="tactic">eauto</span>. <span class="tactic">unfold</span> <span class="id"><a href="compcert.x86.Conventions1.html#loc_argument_acceptable">loc_argument_acceptable</a></span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">x</span>; <span class="tactic">simpl</span> <span class="kwd">in</span> <span class="id">A</span>; <span class="tactic">try</span> <span class="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">sl</span>; <span class="tactic">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;<span class="id">inv</span> <span class="id">A</span>. <span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compcert.backend.Conventions.html#loc_parameters">loc_parameters</a></span>. <span class="tactic">generalize</span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id">sg</span>). <span class="tactic">induction</span> <span class="id">l</span> <span class="kwd">as</span> [ | <span class="id">p</span> <span class="id">l</span>]; <span class="tactic">simpl</span>; <span class="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#map_app">map_app</a></span>. <span class="tactic">f_equal</span>; <span class="tactic">auto</span>. <span class="tactic">destruct</span> <span class="id">p</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<h1> Tail calls </h1>
<br/>
<div class="doc">A tail-call is possible for a signature if the corresponding
    arguments are all passed in registers. </div>
<br/>
<div class="doc">A tail-call is possible for a signature if the corresponding
    arguments are all passed in registers. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="tailcall_possible">tailcall_possible</a></span> (<span class="id">s</span>: <span class="id"><a href="compcert.common.AST.html#signature">signature</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">l</span>, <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#In">In</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> (<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#s">s</a></span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> <span class="kwd">with</span> <span class="id"><a href="compcert.backend.Locations.html#R">R</a></span> <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span> | <span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span> <span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Decide whether a tailcall is possible. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="tailcall_is_possible">tailcall_is_possible</a></span> (<span class="id">sg</span>: <span class="id"><a href="compcert.common.AST.html#signature">signature</a></span>) : <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#bool">bool</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#forallb">List.forallb</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">fun</span> <span class="id">l</span> =&gt; <span class="kwd">match</span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> <span class="kwd">with</span> <span class="id"><a href="compcert.backend.Locations.html#R">R</a></span> <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span> | <span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="compcert.common.AST.html#regs_of_rpairs">regs_of_rpairs</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>)).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="tailcall_is_possible_correct">tailcall_is_possible_correct</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s</span>, <span class="id"><a href="compcert.backend.Conventions.html#tailcall_is_possible">tailcall_is_possible</a></span> <span class="id"><a href="compcert.backend.Conventions.html#s">s</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span> -&gt; <span class="id"><a href="compcert.backend.Conventions.html#tailcall_possible">tailcall_possible</a></span> <span class="id"><a href="compcert.backend.Conventions.html#s">s</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4011')">Proof.</div>
<div class="proofscript" id="proof4011">
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compcert.backend.Conventions.html#tailcall_is_possible">tailcall_is_possible</a></span>; <span class="tactic">intros</span>. <span class="tactic">rewrite</span> <span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#forallb_forall">forallb_forall</a></span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="tactic">destruct</span> <span class="id">l</span>; [<span class="tactic">auto</span>|<span class="tactic">discriminate</span>].<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="zero_size_arguments_tailcall_possible">zero_size_arguments_tailcall_possible</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sg</span>, <span class="id"><a href="compcert.x86.Conventions1.html#size_arguments">size_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span> = 0 -&gt; <span class="id"><a href="compcert.backend.Conventions.html#tailcall_possible">tailcall_possible</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4012')">Proof.</div>
<div class="proofscript" id="proof4012">
&nbsp;&nbsp;<span class="tactic">intros</span>; <span class="tactic">red</span>; <span class="tactic">intros</span>. <span class="id">exploit</span> <span class="id"><a href="compcert.backend.Conventions.html#loc_arguments_acceptable_2">loc_arguments_acceptable_2</a></span>; <span class="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="tactic">unfold</span> <span class="id"><a href="compcert.x86.Conventions1.html#loc_argument_acceptable">loc_argument_acceptable</a></span>.<br/>
&nbsp;&nbsp;<span class="tactic">destruct</span> <span class="id">l</span>; <span class="tactic">intros</span>. <span class="tactic">auto</span>. <span class="tactic">destruct</span> <span class="id">sl</span>; <span class="tactic">try</span> <span class="id">contradiction</span>. <span class="tactic">destruct</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments_bounded">loc_arguments_bounded</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">H0</span>).<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id"><a href="compcert.backend.Locations.html#typesize_pos">typesize_pos</a></span> <span class="id">ty</span>). <span class="tactic">omega</span>.<br/>
Qed.</div>
<br/>
<br/>
<h1> Callee-save locations </h1>
<br/>
<div class="doc">We classify locations as either
<ul>
<li>
 callee-save, i.e. preserved across function calls:
  callee-save registers, <span class="bracket"><span class="kwd">Local</span></span> and <span class="bracket"><span class="id">Incoming</span></span> stack slots;
</li>
<li>
 caller-save, i.e. possibly modified by a function call:
  non-callee-save registers, <span class="bracket"><span class="id">Outgoing</span></span> stack slots.
</li>
</ul>
Concerning <span class="bracket"><span class="id">Outgoing</span></span> stack slots: several ABIs allow a function to modify
the stack slots used for passing parameters to this function.
The code currently generated by CompCert never does so, but the code
generated by other compilers often does so (e.g. GCC for x86-32).
Hence, CompCert-generated code must not assume that <span class="bracket"><span class="id">Outgoing</span></span> stack slots
are preserved across function calls, because they might not be preserved
if the called function was compiled by another compiler. 
</div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="callee_save_loc">callee_save_loc</a></span> (<span class="id">l</span>: <span class="id"><a href="compcert.backend.Locations.html#loc">loc</a></span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="compcert.backend.Locations.html#R">R</a></span> <span class="id">r</span> =&gt; <span class="id"><a href="compcert.x86.Conventions1.html#is_callee_save">is_callee_save</a></span> <span class="id">r</span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id">sl</span> <span class="id">ofs</span> <span class="id">ty</span> =&gt; <span class="id">sl</span> &lt;&gt; <span class="id"><a href="compcert.backend.Locations.html#Outgoing">Outgoing</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Hint</span> <span class="kwd">Unfold</span> <span class="id"><a href="compcert.backend.Conventions.html#callee_save_loc">callee_save_loc</a></span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="agree_callee_save">agree_callee_save</a></span> (<span class="id">ls1</span> <span class="id">ls2</span>: <span class="id"><a href="compcert.backend.Locations.html#Locmap.t">Locmap.t</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">l</span>, <span class="id"><a href="compcert.backend.Conventions.html#callee_save_loc">callee_save_loc</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> -&gt; <span class="id"><a href="compcert.backend.Conventions.html#ls1">ls1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> = <span class="id"><a href="compcert.backend.Conventions.html#ls2">ls2</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>.<br/>
<br/>
<h1> Assigning result locations </h1>
<br/>
<div class="doc">Useful lemmas to reason about the result of an external call. </div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="locmap_get_set_loc_result">locmap_get_set_loc_result</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sg</span> <span class="id">v</span> <span class="id">rs</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> <span class="kwd">with</span> <span class="id"><a href="compcert.backend.Locations.html#R">R</a></span> <span class="id">r</span> =&gt; <span class="id"><a href="compcert.x86.Conventions1.html#is_callee_save">is_callee_save</a></span> <span class="id">r</span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span> | <span class="id"><a href="compcert.backend.Locations.html#S">S</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span> <span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Locations.html#Locmap.setpair">Locmap.setpair</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_result">loc_result</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>) <span class="id"><a href="compcert.backend.Conventions.html#v">v</a></span> <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> = <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4013')">Proof.</div>
<div class="proofscript" id="proof4013">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id"><a href="compcert.backend.Locations.html#Locmap.gpo">Locmap.gpo</a></span>. <br/>
&nbsp;&nbsp;<span class="tactic">assert</span> (<span class="id">X</span>: <span class="kwd">forall</span> <span class="id">r</span>, <span class="id"><a href="compcert.x86.Conventions1.html#is_callee_save">is_callee_save</a></span> <span class="id"><a href="compcert.backend.Conventions.html#r">r</a></span> = <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span> -&gt; <span class="id"><a href="compcert.backend.Locations.html#Loc.diff">Loc.diff</a></span> <span class="id">l</span> (<span class="id"><a href="compcert.backend.Locations.html#R">R</a></span> <span class="id"><a href="compcert.backend.Conventions.html#r">r</a></span>)).<br/>
&nbsp;&nbsp;{ <span class="tactic">intros</span>. <span class="tactic">destruct</span> <span class="id">l</span>; <span class="tactic">simpl</span>. <span class="tactic">congruence</span>. <span class="tactic">auto</span>. }<br/>
&nbsp;&nbsp;<span class="tactic">generalize</span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_result_caller_save">loc_result_caller_save</a></span> <span class="id">sg</span>). <span class="tactic">destruct</span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_result">loc_result</a></span> <span class="id">sg</span>); <span class="tactic">simpl</span>; <span class="tactic">intuition</span> <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="locmap_get_set_loc_result_callee_save">locmap_get_set_loc_result_callee_save</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sg</span> <span class="id">v</span> <span class="id">rs</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Conventions.html#callee_save_loc">callee_save_loc</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Locations.html#Locmap.setpair">Locmap.setpair</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_result">loc_result</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>) <span class="id"><a href="compcert.backend.Conventions.html#v">v</a></span> <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span> = <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>.<br/>
<div class="toggleproof" onclick="toggleDisplay('proof4014')">Proof.</div>
<div class="proofscript" id="proof4014">
&nbsp;&nbsp;<span class="tactic">intros</span>. <span class="tactic">apply</span> <span class="id"><a href="compcert.backend.Conventions.html#locmap_get_set_loc_result">locmap_get_set_loc_result</a></span>. <br/>
&nbsp;&nbsp;<span class="tactic">red</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="tactic">destruct</span> <span class="id">l</span>; <span class="tactic">auto</span>.<br/>
Qed.</div>
<br/>
<br/>
<h1> Language interface for locations </h1>
<br/>
<div class="doc">Languages with <span class="bracket"><span class="id">locset</span></span>s (currently LTL and Linear) use the
  following interface. We need to keep the C-level signature until
  Linear because it determines the stack layout used by the Linear
  to Mach calling convention to map locations to memory addresses. </div>
<br/>
<span class="kwd">Record</span> <span class="id"><a name="locset_query">locset_query</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a name="lq">lq</a></span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a name="lq_vf">lq_vf</a></span>: <span class="id"><a href="compcert.common.Values.html#val">val</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a name="lq_sg">lq_sg</a></span>: <span class="id"><a href="compcert.common.AST.html#signature">signature</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a name="lq_rs">lq_rs</a></span>: <span class="id"><a href="compcert.backend.Locations.html#Locmap.t">Locmap.t</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a name="lq_mem">lq_mem</a></span>: <span class="id"><a href="compcert.common.Memory.html#mem">mem</a></span>;<br/>
&nbsp;&nbsp;}.<br/>
<br/>
<span class="kwd">Record</span> <span class="id"><a name="locset_reply">locset_reply</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a name="lr">lr</a></span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a name="lr_rs">lr_rs</a></span>: <span class="id"><a href="compcert.backend.Locations.html#Locmap.t">Locmap.t</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a name="lr_mem">lr_mem</a></span>: <span class="id"><a href="compcert.common.Memory.html#mem">mem</a></span>;<br/>
&nbsp;&nbsp;}.<br/>
<br/>
<span class="id">Canonical</span> <span class="kwd">Structure</span> <span class="id">li_locset</span>: <span class="id"><a href="compcert.common.LanguageInterface.html#language_interface">language_interface</a></span> :=<br/>
&nbsp;&nbsp;{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.LanguageInterface.html#mk_language_interface">query</a></span> := <span class="id"><a href="compcert.backend.Conventions.html#locset_query">locset_query</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reply</span> := <span class="id"><a href="compcert.backend.Conventions.html#locset_reply">locset_reply</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entry</span> := <span class="id"><a href="compcert.backend.Conventions.html#lq_vf">lq_vf</a></span>;<br/>
&nbsp;&nbsp;|}.<br/>
<br/>
<h1> Calling convention </h1>
<br/>
<div class="doc">We first define the calling convention between C and locset
  languages, which relates the C-level argument list to the contents
  of the locations. The Kripke world keeps track of the signature and
  initial values registers, so that the return value can be
  interpreted in the correct way and the preservation of callee-save
  registers can be enforced. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="cc_alloc_mq">cc_alloc_mq</a></span>: <span class="id"><a href="compcert.common.AST.html#signature">signature</a></span> * <span class="id"><a href="compcert.backend.Locations.html#Locmap.t">Locmap.t</a></span> -&gt; <span class="id"><a href="compcert.common.LanguageInterface.html#c_query">c_query</a></span> -&gt; <span class="id"><a href="compcert.backend.Conventions.html#locset_query">locset_query</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a name="cc_alloc_mq_intro">cc_alloc_mq_intro</a></span> <span class="id">vf</span> <span class="id">sg</span> <span class="id">args</span> <span class="id">rs</span> <span class="id">m1</span> <span class="id">m2</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Values.html#Val.lessdef_list">Val.lessdef_list</a></span> <span class="id"><a href="compcert.backend.Conventions.html#args">args</a></span> (<span class="id"><a href="http://coq.inria.fr/library/Coq.Lists.List.html#map">map</a></span> (<span class="kwd">fun</span> <span class="id">p</span> =&gt; <span class="id"><a href="compcert.backend.Locations.html#Locmap.getpair">Locmap.getpair</a></span> <span class="id"><a href="compcert.backend.Conventions.html#p">p</a></span> <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span>) (<span class="id"><a href="compcert.x86.Conventions1.html#loc_arguments">loc_arguments</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Memory.html#Mem.extends">Mem.extends</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Values.html#Val.has_type_list">Val.has_type_list</a></span> <span class="id"><a href="compcert.backend.Conventions.html#args">args</a></span> (<span class="id"><a href="compcert.common.AST.html#sig_args">sig_args</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Conventions.html#cc_alloc_mq">cc_alloc_mq</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>, <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span>) (<span class="id"><a href="compcert.common.LanguageInterface.html#cq">cq</a></span> <span class="id"><a href="compcert.backend.Conventions.html#vf">vf</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span> <span class="id"><a href="compcert.backend.Conventions.html#args">args</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span>) (<span class="id"><a href="compcert.backend.Conventions.html#lq">lq</a></span> <span class="id"><a href="compcert.backend.Conventions.html#vf">vf</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span> <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span>).<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="cc_alloc_mr">cc_alloc_mr</a></span>: <span class="id"><a href="compcert.common.AST.html#signature">signature</a></span> * <span class="id"><a href="compcert.backend.Locations.html#Locmap.t">Locmap.t</a></span> -&gt; <span class="id"><a href="compcert.common.LanguageInterface.html#c_reply">c_reply</a></span> -&gt; <span class="id"><a href="compcert.backend.Conventions.html#locset_reply">locset_reply</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a name="cc_alloc_mr_intro">cc_alloc_mr_intro</a></span> <span class="id">sg</span> <span class="id">rs</span> <span class="id">res</span> <span class="id">rs</span>' <span class="id">m1</span> <span class="id">m2</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Values.html#Val.lessdef">Val.lessdef</a></span> <span class="id"><a href="compcert.backend.Conventions.html#res">res</a></span> (<span class="id"><a href="compcert.backend.Locations.html#Locmap.getpair">Locmap.getpair</a></span> (<span class="id"><a href="compcert.common.AST.html#map_rpair">map_rpair</a></span> <span class="id"><a href="compcert.backend.Locations.html#R">R</a></span> (<span class="id"><a href="compcert.x86.Conventions1.html#loc_result">loc_result</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>)) <span class="id">rs</span>') -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Conventions.html#agree_callee_save">agree_callee_save</a></span> <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span> <span class="id">rs</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Memory.html#Mem.extends">Mem.extends</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Values.html#Val.has_type">Val.has_type</a></span> <span class="id"><a href="compcert.backend.Conventions.html#res">res</a></span> (<span class="id"><a href="compcert.common.AST.html#proj_sig_res">proj_sig_res</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Conventions.html#cc_alloc_mr">cc_alloc_mr</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span>, <span class="id"><a href="compcert.backend.Conventions.html#rs">rs</a></span>) (<span class="id"><a href="compcert.common.LanguageInterface.html#cr">cr</a></span> <span class="id"><a href="compcert.backend.Conventions.html#res">res</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span>) (<span class="id"><a href="compcert.backend.Conventions.html#lr">lr</a></span> <span class="id">rs</span>' <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span>).<br/>
<br/>
<span class="kwd">Program</span> <span class="kwd">Definition</span> <span class="id"><a name="cc_alloc">cc_alloc</a></span>: <span class="id"><a href="compcert.common.LanguageInterface.html#callconv">callconv</a></span> <span class="id"><a href="compcert.common.LanguageInterface.html#li_c">li_c</a></span> <span class="id"><a href="compcert.backend.Conventions.html#li_locset">li_locset</a></span> :=<br/>
&nbsp;&nbsp;{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.LanguageInterface.html#mk_callconv">match_senv</a></span> <span class="id">w</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#eq">eq</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_query</span> := <span class="id"><a href="compcert.backend.Conventions.html#cc_alloc_mq">cc_alloc_mq</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_reply</span> := <span class="id"><a href="compcert.backend.Conventions.html#cc_alloc_mr">cc_alloc_mr</a></span>;<br/>
&nbsp;&nbsp;|}.<br/>
<br/>
<div class="doc">The extension convention is used by the Tunneling proof. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="cc_locset_ext_query">cc_locset_ext_query</a></span>: <span class="id"><a href="compcert.backend.Conventions.html#locset_query">locset_query</a></span> -&gt; <span class="id"><a href="compcert.backend.Conventions.html#locset_query">locset_query</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a name="cc_locset_ext_query_intro">cc_locset_ext_query_intro</a></span> <span class="id">vf</span> <span class="id">sg</span> <span class="id">ls1</span> <span class="id">ls2</span> <span class="id">m1</span> <span class="id">m2</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">l</span>, <span class="id"><a href="compcert.common.Values.html#Val.lessdef">Val.lessdef</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#ls1">ls1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>) (<span class="id"><a href="compcert.backend.Conventions.html#ls2">ls2</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Memory.html#Mem.extends">Mem.extends</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Conventions.html#cc_locset_ext_query">cc_locset_ext_query</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#lq">lq</a></span> <span class="id"><a href="compcert.backend.Conventions.html#vf">vf</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ls1">ls1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span>) (<span class="id"><a href="compcert.backend.Conventions.html#lq">lq</a></span> <span class="id"><a href="compcert.backend.Conventions.html#vf">vf</a></span> <span class="id"><a href="compcert.backend.Conventions.html#sg">sg</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ls2">ls2</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span>).<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="cc_locset_ext_reply">cc_locset_ext_reply</a></span>: <span class="id"><a href="compcert.backend.Conventions.html#locset_reply">locset_reply</a></span> -&gt; <span class="id"><a href="compcert.backend.Conventions.html#locset_reply">locset_reply</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a name="cc_locset_ext_reply_intro">cc_locset_ext_reply_intro</a></span> <span class="id">ls1</span> <span class="id">ls2</span> <span class="id">m1</span> <span class="id">m2</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">l</span>, <span class="id"><a href="compcert.common.Values.html#Val.lessdef">Val.lessdef</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#ls1">ls1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>) (<span class="id"><a href="compcert.backend.Conventions.html#ls2">ls2</a></span> <span class="id"><a href="compcert.backend.Conventions.html#l">l</a></span>)) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.Memory.html#Mem.extends">Mem.extends</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.backend.Conventions.html#cc_locset_ext_reply">cc_locset_ext_reply</a></span> (<span class="id"><a href="compcert.backend.Conventions.html#lr">lr</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ls1">ls1</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m1">m1</a></span>) (<span class="id"><a href="compcert.backend.Conventions.html#lr">lr</a></span> <span class="id"><a href="compcert.backend.Conventions.html#ls2">ls2</a></span> <span class="id"><a href="compcert.backend.Conventions.html#m2">m2</a></span>).<br/>
<br/>
<span class="kwd">Program</span> <span class="kwd">Definition</span> <span class="id"><a name="cc_locset_ext">cc_locset_ext</a></span> :=<br/>
&nbsp;&nbsp;{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="compcert.common.LanguageInterface.html#mk_callconv">ccworld</a></span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Datatypes.html#unit">unit</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_senv</span> <span class="id">w</span> := <span class="id"><a href="http://coq.inria.fr/library/Coq.Init.Logic.html#eq">eq</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_query</span> <span class="id">w</span> := <span class="id"><a href="compcert.backend.Conventions.html#cc_locset_ext_query">cc_locset_ext_query</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">match_reply</span> <span class="id">w</span> := <span class="id"><a href="compcert.backend.Conventions.html#cc_locset_ext_reply">cc_locset_ext_reply</a></span>;<br/>
&nbsp;&nbsp;|}.<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
